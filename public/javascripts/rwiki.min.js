Ext.ns('Rwiki');Rwiki.TabPanel=Ext.extend(Ext.TabPanel,{initComponent:function(){this.editPageButton=new Ext.Button({text:'Edit page',iconCls:'icon-edit',scope:this,handler:this.onEditPage,disabled:true});this.printPageButton=new Ext.Button({text:'Print page',iconCls:'icon-print',scope:this,handler:this.onPrint,disabled:true});this.findPageButton=new Ext.Button({text:'Find page',iconCls:'icon-search',scope:this,handler:this.onFuzzyFinder});Ext.applyIf(this,{region:'center',deferredRender:false,activeTab:0,enableTabScroll:true,defaults:{autoScroll:true},plugins:new Ext.ux.TabCloseMenu(),tbar:[this.editPageButton,this.printPageButton,this.findPageButton]});Rwiki.TabPanel.superclass.initComponent.apply(this,arguments);},initEvents:function(){Rwiki.TabPanel.superclass.initEvents.apply(this,arguments);this.addEvents('rwiki:editPage');this.on('rwiki:pageSelected',this.onPageSelected),this.on('tabchange',this.onTabChange);this.on('rwiki:pageCreated',this.onPageCreated);this.on('rwiki:pageLoaded',this.onPageLoaded);this.on('rwiki:lastPageClosed',this.onLastPageClosed);this.on('rwiki:pageSaved',this.onPageSaved);this.on('rwiki:nodeRenamed',this.onNodeRenamed);this.on('rwiki:nodeDeleted',this.onNodeDeleted);this.relayEvents(Rwiki.Data.NodeManager.getInstance(),['rwiki:pageLoaded','rwiki:folderCreated','rwiki:lastPageClosed','rwiki:pageCreated','rwiki:pageSaved','rwiki:nodeRenamed','rwiki:nodeDeleted']);},findOrCreatePageTab:function(page){var tab=this.findTabByPagePath(page.getPath());if(!tab){tab=this.createPageTab(page);}
return tab;},createPageTab:function(page){var tab=new Rwiki.Tabs.PageTab({title:page.getTitle()});tab.setPagePath(page.getPath());this.add(tab);return tab;},findTabByPagePath:function(pagePath){return this.findBy(function(){return this.getPagePath()==pagePath;})[0];},findTabsByParentPath:function(parentPath){return this.findBy(function(){var path=this.getPagePath();return Rwiki.Data.NodeManager.getInstance().isParent(parentPath,path);});},onPageSelected:function(page){var tab=this.findOrCreatePageTab(page);tab.show();},onTabChange:function(panel,tab){if(tab){if(tab.isLoading()){return;}
Ext.History.add(tab.getPagePath());document.title='Rwiki '+tab.getPagePath();Rwiki.Data.NodeManager.getInstance().loadPage(tab.getPagePath());tab.setIsLoading(true);}else{document.title='Rwiki';Rwiki.Data.NodeManager.getInstance().fireEvent('rwiki:lastPageClosed');}},onPageCreated:function(page){var tab=this.createPageTab(page);tab.show();},onPageLoaded:function(page){var tab=this.findOrCreatePageTab(page);tab.setTitle(page.getTitle());tab.setContent(page.getHtmlContent());tab.show();tab.setIsLoading(false);this.editPageButton.setDisabled(false);this.printPageButton.setDisabled(false);},onLastPageClosed:function(){this.editPageButton.setDisabled(true);this.printPageButton.setDisabled(true);},onPageSaved:function(page){var tab=this.findTabByPagePath(page.getPath());if(tab==null)return;tab.setContent(page.getHtmlContent());},onNodeRenamed:function(page){var oldPath=page.getData().oldPath;var currentTab=this.getActiveTab();var tab=null;var isPage=oldPath.match(new RegExp('\.txt$'));if(isPage){tab=this.findTabByPagePath(oldPath);if(tab==null)return;tab.setPagePath(page.getPath());tab.setTitle(page.getTitle());if(tab==currentTab){document.title='Rwiki '+page.getPath();}}else{var tabs=this.findTabsByParentPath(oldPath);for(var i=0;i<tabs.length;i++){tab=tabs[i];var newPath=tab.getPagePath().replace(oldPath,page.getPath());tab.setPagePath(newPath);if(tab==currentTab){document.title='Rwiki '+newPath;}}}},onNodeDeleted:function(data){var tabs=this.findTabsByParentPath(data.path);for(var i=0;i<tabs.length;i++){var tab=tabs[i];this.remove(tab);}},onEditPage:function(){var currentTab=this.getActiveTab();if(currentTab){this.fireEvent('rwiki:editPage',currentTab.getPagePath());}},onFuzzyFinder:function(){var fuzzyFinder=new Rwiki.FuzzyFinderWindow();fuzzyFinder.show();},onPrint:function(){var currentTab=this.getActiveTab();if(currentTab){var path=currentTab.getPagePath();window.open('/node/print?path='+path,'Rwiki '+path,'width=800,height=600,scrollbars=yes')}}});Ext.ns('Rwiki');Rwiki.EditorWindow=Ext.extend(Ext.Window,{constructor:function(){this.editorPanel=new Rwiki.Editor.Panel();Ext.apply(this,{maximizable:true,modal:true,width:750,height:500,minWidth:300,minHeight:200,layout:'fit',plain:true,bodyStyle:'padding: 5px;',buttonAlign:'center',items:this.editorPanel,buttons:[{text:'Save',scope:this,handler:this.onSaveButton,iconCls:'icon-save'},{text:'Save and continue',scope:this,handler:this.onSaveAndContinueButton,iconCls:'icon-save'},{text:'Cancel',scope:this,handler:this.onCancelButton,iconCls:'icon-cancel'}]});Rwiki.EditorWindow.superclass.constructor.apply(this,arguments);},setPagePath:function(path){this.pagePath=path;this.setTitle('Editing page '+path);},show:function(){Rwiki.Data.NodeManager.getInstance().loadPage(this.pagePath);Rwiki.EditorWindow.superclass.show.apply(this,arguments);Ext.get('editor-container').mask('Loading the page...');},savePage:function(){Rwiki.Data.NodeManager.getInstance().savePage(this.pagePath,this.editorPanel.getContent());},onSaveButton:function(){this.savePage();this.hide();},onSaveAndContinueButton:function(){this.savePage();},onCancelButton:function(){this.hide();},close:function(){this.hide();}});Ext.ns('Rwiki.Editor');Rwiki.Editor.Panel=Ext.extend(Ext.Panel,{constructor:function(){Ext.apply(this,{contentEl:'editor-container',header:false,height:400,listeners:{resize:function(panel,width,height){var offset=36-25;$('.markItUpContainer').height(height-offset);var editorOffset=73-25;$('#editor').height(height-editorOffset);}}});Rwiki.Editor.Panel.superclass.constructor.apply(this,arguments);this.editorContainer=$('textarea#editor');this.initMarkItUp();},initMarkItUp:function(){var textileSettings={nameSpace:"textile",onShiftEnter:{keepDefault:false,replaceWith:'\n\n'},markupSet:[{name:'Heading 1',key:'1',openWith:'h1(!(([![Class]!]))!). ',placeHolder:'Your title here...'},{name:'Heading 2',key:'2',openWith:'h2(!(([![Class]!]))!). ',placeHolder:'Your title here...'},{name:'Heading 3',key:'3',openWith:'h3(!(([![Class]!]))!). ',placeHolder:'Your title here...'},{name:'Heading 4',key:'4',openWith:'h4(!(([![Class]!]))!). ',placeHolder:'Your title here...'},{name:'Heading 5',key:'5',openWith:'h5(!(([![Class]!]))!). ',placeHolder:'Your title here...'},{name:'Heading 6',key:'6',openWith:'h6(!(([![Class]!]))!). ',placeHolder:'Your title here...'},{name:'Paragraph',key:'P',openWith:'p(!(([![Class]!]))!). '},{separator:'---------------'},{name:'Bold',key:'B',closeWith:'*',openWith:'*'},{name:'Italic',key:'I',closeWith:'_',openWith:'_'},{name:'Stroke through',key:'S',closeWith:'-',openWith:'-'},{separator:'---------------'},{name:'Bulleted list',openWith:'(!(* |!|*)!)'},{name:'Numeric list',openWith:'(!(# |!|#)!)'},{separator:'---------------'},{name:'Picture',replaceWith:'![![Source:!:http://]!]([![Alternative text]!])!'},{name:'Link',openWith:'"',closeWith:'([![Title]!])":[![Link:!:http://]!]',placeHolder:'Your text to link here...'},{separator:'---------------'},{name:'Quotes',openWith:'bq(!(([![Class]!]))!). '},{separator:'---------------'},{name:'Code',openWith:'<code>\n',closeWith:'\n</code>',className:'insert-code'},{name:'Ruby Code',openWith:'<code lang="ruby">\n',closeWith:'\n</code>',className:'insert-code ruby'},{name:'JavaScript Code',openWith:'<code lang="javascript">\n',closeWith:'\n</code>',className:'insert-code javascript'},{name:'HTML Code',openWith:'<code lang="html">\n',closeWith:'\n</code>',className:'insert-code html'},{name:'Css Code',openWith:'<code lang="css">\n',closeWith:'\n</code>',className:'insert-code css'}],resizeHandle:false};this.editorContainer.markItUp(textileSettings);},initEvents:function(){Rwiki.Editor.Panel.superclass.initEvents.apply(this,arguments);this.relayEvents(Rwiki.Data.NodeManager.getInstance(),['rwiki:pageLoaded']);this.on('rwiki:pageLoaded',this.onPageLoaded);},onPageLoaded:function(page){this.setContent(page.getRawContent());Ext.get('editor-container').unmask();},setContent:function(content){this.editorContainer.val(content);},getContent:function(){return this.editorContainer.val();},clearContent:function(){this.editorContainer.val('');}});Ext.ns('Rwiki');Rwiki.TreePanel=Ext.extend(Ext.tree.TreePanel,{constructor:function(){var toolbar=new Rwiki.Tree.Toolbar();Ext.apply(this,{id:'tree',region:'center',autoScroll:true,animate:true,useArrows:true,rootVisible:true,loader:new Rwiki.Tree.Loader(),enableDD:true,dropConfig:{appendOnly:true},root:new Rwiki.Tree.Node({nodeType:'async',text:Rwiki.rootFolderName,draggable:false,baseName:'.'}),tbar:toolbar});Rwiki.TreePanel.superclass.constructor.apply(this,arguments);this.contextMenu=new Rwiki.Tree.Menu();this.on('contextmenu',this.onContextMenu,this);this.filter=new Rwiki.Tree.Filter(this);this.root.expand();new Ext.tree.TreeSorter(this,{folderSort:true});var self=this;toolbar.on('expandAll',function(){self.root.expandChildNodes(true);});toolbar.on('collapseAll',function(){self.root.collapseChildNodes(true);});toolbar.on('filterFieldChanged',function(text){self.filter.filterTree(text);});this.addEvents('rwiki:pageSelected');},initEvents:function(){Rwiki.TreePanel.superclass.initEvents.apply(this,arguments);this.on('click',this.onClick);this.on('rwiki:pageLoaded',this.onPageLoaded);this.on('rwiki:folderCreated',this.onFolderCreated);this.on('rwiki:pageCreated',this.onPageCreated);this.on('rwiki:nodeRenamed',this.onNodeRenamed);this.on('rwiki:nodeDeleted',this.onNodeDeleted);this.on('beforemovenode',this.onBeforeMoveNode);this.relayEvents(Rwiki.Data.NodeManager.getInstance(),['rwiki:pageLoaded','rwiki:folderCreated','rwiki:pageCreated','rwiki:nodeRenamed','rwiki:nodeDeleted']);},onContextMenu:function(node,e){if(!this.contextMenu)return;if(!node){node=this.getSelectionModel().getSelectedNode();}
this.contextMenu.show(node,e.getXY());},onClick:function(node){if(!node.isLeaf())return;var page=new Rwiki.Data.Node({path:node.getPath()});this.fireEvent('rwiki:pageSelected',page);},onPageLoaded:function(page){var node=this.findNodeByPath(page.getPath());if(node){node.select();}},onFolderCreated:function(page){var node=new Rwiki.Tree.Node({baseName:page.getBaseName(),text:page.getTitle(),cls:'folder',expandable:true,leaf:false});var parentNode=this.findNodeByPath(page.getParentPath());parentNode.expand();parentNode.appendChild(node);},onPageCreated:function(page){var treeNode=new Rwiki.Tree.Node({baseName:page.getBaseName(),text:page.getTitle(),cls:'page',expandable:false,leaf:true});var parentNode=this.findNodeByPath(page.getParentPath());parentNode.expand();parentNode.appendChild(treeNode);treeNode.select();},onNodeRenamed:function(page){var treeNode=this.findNodeByPath(page.getData().oldPath);treeNode.setBaseName(page.getBaseName());treeNode.setText(page.getTitle());},onNodeDeleted:function(data){var path=data.path;var node=this.findNodeByPath(path);node.remove();},onBeforeMoveNode:function(tree,node,oldParent,newParent,index){var path=node.getPath();var newParentPath=newParent.getPath();var result=Rwiki.Data.NodeManager.getInstance().moveNode(path,newParentPath);return result.success;},findNodeByPath:function(path){var node=null;this.root.cascadeAll(function(curretNode){if(curretNode.getPath()==path){node=curretNode;return false;}});return node;},openNodeFromLocationHash:function(){if(!location.hash)return;var path=location.hash.replace(new RegExp('^#'),'');var node=this.findNodeByPath(path);if(node){node.expandAll();this.onClick(node);}}});Ext.ns('Rwiki.Data');Rwiki.Data.Node=function(data){this._data=data;};Rwiki.Data.Node.prototype={getData:function(){return this._data;},getHtmlContent:function(){return this._data.htmlContent;},getRawContent:function(){return this._data.rawContent;},getPath:function(){return this._data.path;},getParentPath:function(){return this._data.parentPath;},getBaseName:function(){return this.getPath().split('/').pop();},getTitle:function(){return this.getBaseName().replace(new RegExp('\.txt$'),'');}};Ext.ns('Rwiki.Data');Rwiki.Data.NodeManager=Ext.extend(Ext.util.Observable,{constructor:function(){if(Rwiki.Data.NodeManager.caller!=Rwiki.Data.NodeManager.getInstance){throw new Error("There is no public constructor for Rwiki.Data.NodeManager");}
this.timeout=5000;this.initEvents();Ext.Ajax.on('requestexception',this.onAjaxException);},onAjaxException:function(){alert('Something went wrong...');},initEvents:function(){this.addEvents('rwiki:beforePageLoad','rwiki:pageLoaded','rwiki:nodeDeleted','rwiki:folderCreated','rwiki:pageCreated','rwiki:pageSaved','rwiki:nodeRenamed','rwiki:lastPageClosed');},loadPage:function(path){var page=new Rwiki.Data.Node({path:path});this.fireEvent('rwiki:beforePageLoad',page);Ext.Ajax.request({url:'/node',method:'GET',params:{path:path},scope:this,timeout:this.timeout,success:function(response){var data=Ext.decode(response.responseText);var page=new Rwiki.Data.Node(data);this.fireEvent('rwiki:pageLoaded',page);}});},createFolder:function(parentPath,name){this._createNode(parentPath,name,true);},createPage:function(parentPath,name){this._createNode(parentPath,name,false);},_createNode:function(parentPath,name,isFolder){Ext.Ajax.request({url:'/node',type:'POST',params:{parentPath:parentPath,name:name,isFolder:isFolder},scope:this,timeout:this.timeout,success:function(response){var data=Ext.decode(response.responseText);var page=new Rwiki.Data.Node(data);if(isFolder){this.fireEvent('rwiki:folderCreated',page);}else{this.fireEvent('rwiki:pageCreated',page);}}});},savePage:function(path,rawContent){Ext.Ajax.request({url:'/node',method:'PUT',params:{path:path,rawContent:rawContent},scope:this,timeout:this.timeout,success:function(response){var data=Ext.decode(response.responseText);var page=new Rwiki.Data.Node(data);this.fireEvent('rwiki:pageSaved',page);}});},renameNode:function(oldPath,newName){Ext.Ajax.request({url:'/node/rename',method:'POST',params:{path:oldPath,newName:newName},scope:this,timeout:this.timeout,success:function(response){var data=Ext.decode(response.responseText);var page=new Rwiki.Data.Node(data);this.fireEvent('rwiki:nodeRenamed',page);}});},deleteNode:function(path){Ext.Ajax.request({url:'/node',method:'DELETE',params:{path:path},scope:this,timeout:this.timeout,success:function(response){var data=Ext.decode(response.responseText);this.fireEvent('rwiki:nodeDeleted',data);}});},moveNode:function(path,newParentPath){var self=this;var result=$.ajax({type:'PUT',url:'/node/move',dataType:'json',async:false,data:{path:path,newParentPath:newParentPath},timeout:this.timeout,success:function(data){var page=new Rwiki.Data.Node(data);self.fireEvent('rwiki:nodeRenamed',page);}});return Ext.util.JSON.decode(result.responseText);},isParent:function(parentPath,path){var parentParts=parentPath.split('/');var pathParts=path.split('/');var result=true;var n=Math.min(parentParts.length,pathParts.length);for(var i=0;i<n;i++){if(parentParts[i]!=pathParts[i]){result=false;break;}}
return result;}});Rwiki.Data.NodeManager._instance=null;Rwiki.Data.NodeManager.getInstance=function(){if(this._instance==null){this._instance=new Rwiki.Data.NodeManager();}
return this._instance;};Ext.ns('Rwiki.Tabs');Rwiki.Tabs.PageTab=Ext.extend(Ext.Container,{constructor:function(){Ext.apply(this,{closable:true,cls:'page-container',iconCls:'icon-page'});Rwiki.Tabs.PageTab.superclass.constructor.apply(this,arguments);},isLoading:function(){return this._isLoading;},setIsLoading:function(isLoading){this._isLoading=isLoading;if(isLoading){this.mask=new Ext.LoadMask(Ext.get(this.id),{msg:'Loading the Page...'});this.mask.show();}else if(this.mask){this.mask.hide();}},getPagePath:function(){return this.path;},setPagePath:function(path){this.path=path;},setContent:function(htmlContent){var pageContainer=this.getPageContainer();pageContainer.html(htmlContent);},getPageContainer:function(){return $('#'+this.id);},setTitle:function(title){$(this.tabEl).find('.x-tab-strip-text').text(title);}});Ext.ns('Rwiki');Rwiki.FuzzyFinderWindow=Ext.extend(Ext.Window,{constructor:function(){var self=this;var dataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({method:'GET',url:'/fuzzy_finder'}),reader:new Ext.data.JsonReader({root:'results',totalProperty:'count',id:'path'},[{name:'path',mapping:'path'},{name:'score',mapping:'score'},{name:'highlighted_path',mapping:'highlighted_path'}])});var resultTpl=new Ext.XTemplate('<tpl for="."><div class="search-item">','{highlighted_path}','</div></tpl>');var search=new Ext.form.ComboBox({store:dataStore,minChars:2,displayField:'title',typeAhead:false,loadingText:'Searching...',hideTrigger:true,tpl:resultTpl,itemSelector:'div.search-item',onSelect:function(record){var path=record.data.path;Rwiki.nodeManager.loadPage(path);self.close();}});Ext.apply(this,{title:'FuzzyFinder',maximizable:false,modal:true,width:600,layout:'fit',plain:true,bodyStyle:'padding: 5px;',items:[search],defaultButton:search});Rwiki.FuzzyFinderWindow.superclass.constructor.apply(this,arguments);}});Ext.ns('Rwiki.Tree');Rwiki.Tree.Menu=Ext.extend(Ext.menu.Menu,{constructor:function(){Ext.apply(this,{id:'feeds-ctx',items:[{text:'Create folder',id:'create-folder',iconCls:'icon-create-folder',scope:this,handler:this.onCreateFolder},{text:'Create page',id:'create-page',iconCls:'icon-create-page',scope:this,handler:this.onCreatePage},'-',{text:'Rename node',id:'rename-node',iconCls:'icon-rename-node',scope:this,handler:this.onRenameNode},{text:'Delete node',id:'delete-node',iconCls:'icon-delete-node',scope:this,handler:this.onDeleteNode}]});Rwiki.Tree.Menu.superclass.constructor.apply(this,arguments);},show:function(node,xy){this.node=node;node.select();var isRoot=node.id==Rwiki.rootFolderName;this.setItemDisabled('delete-node',isRoot);this.setItemDisabled('rename-node',isRoot);var isPage=node.attributes.cls=='page';this.setItemDisabled('create-folder',isPage);this.setItemDisabled('create-page',isPage);this.showAt(xy);},onCreateFolder:function(){var parentNode=this.node;if(parentNode.cls=='file')return;Ext.MessageBox.prompt('Create folder','New folder name:',function(button,name){if(button!='ok')return;var parentPath=parentNode.getPath('baseName');Rwiki.nodeManager.createFolder(parentPath,name);});},onCreatePage:function(){var parentNode=this.node;if(parentNode.cls=='file')return;Ext.MessageBox.prompt('Create page','New page name:',function(button,name){if(button!='ok')return;var parentPath=parentNode.getPath('baseName');Rwiki.nodeManager.createPage(parentPath,name);});},onRenameNode:function(){var node=this.node;var oldPath=node.getPath('baseName');var oldBaseName=node.text;var callback=function(button,newName){if(button!='ok')return;Rwiki.nodeManager.renameNode(oldPath,newName);};Ext.MessageBox.prompt('Rename node','Enter a new name:',callback,this,false,oldBaseName);},onDeleteNode:function(){var node=this.node;var path=node.getPath('baseName');var callback=function(button){if(button!='yes')return;Rwiki.nodeManager.deleteNode(path);};var message='Delete "'+path+'"?';Ext.MessageBox.confirm('Confirm',message,callback);},setItemDisabled:function(id,disabled){var item=this.findById(id);if(item==null)return;item.setDisabled(disabled);}});Ext.ns('Rwiki.Tree');Rwiki.Tree.Node=Ext.extend(Ext.tree.AsyncTreeNode,{getPath:function(){var path=Rwiki.Tree.Node.superclass.getPath.call(this,'baseName');return path.replace(/^\//,'');},setBaseName:function(baseName){this.attributes.baseName=baseName;},getBaseName:function(){return this.attributes.baseName;},expandAll:function(){var nodes=[];this.bubble(function(n){nodes.push(n);});nodes=nodes.reverse();for(var i=0,len=nodes.length;i<len;i++){var node=nodes[i];if(node.isExpandable()){node.expand(false);}}},cascadeAll:function(fn,scope,args){var wasCollapsed=this.isExpandable()&&!this.isExpanded();if(wasCollapsed){this.expand(false,false);}
if(fn.apply(scope||this,args||[this])!==false){var cs=this.childNodes;for(var i=0,len=cs.length;i<len;i++){cs[i].cascadeAll(fn,args);}}
if(wasCollapsed){this.collapse(false,false);}}});Ext.ns('Rwiki.Tree');Rwiki.Tree.Filter=Ext.extend(Ext.tree.TreeFilter,{constructor:function(){this.hiddenNodes=[];Ext.apply(this,{clearBlank:true,autoClear:true});Rwiki.Tree.Filter.superclass.constructor.apply(this,arguments);},filterTree:function(text){var self=this;Ext.each(this.hiddenNodes,function(node){node.ui.show();});if(!text){this.clear();return;}
this.tree.expandAll();this.markCount=[];this.hiddenNodes=[];if(text.trim().length>0){this.tree.expandAll();var re=new RegExp(Ext.escapeRe(text),'i');this.tree.root.cascade(function(node){if(re.test(node.text)){self.markToRoot(node,self.root);if(!node.isLeaf()){node.cascade(function(child){self.markToRoot(child,node);});}}});this.tree.root.cascade(function(node){if(!self.markCount[node.id]&&node!=self.root){node.ui.hide();self.hiddenNodes.push(node);}});}},markToRoot:function(node,root){if(this.markCount[node.id])return;this.markCount[node.id]=true;if(node.parentNode!=null){this.markToRoot(node.parentNode,root);}}});Ext.ns('Rwiki.Tree');Rwiki.Tree.Toolbar=Ext.extend(Ext.Toolbar,{constructor:function(){var self=this;var filterField=new Ext.form.TextField({width:200,emptyText:'Find a Page',enableKeyEvents:true,listeners:{keydown:{fn:function(){var text=this.getValue();self.fireEvent('filterFieldChanged',text);},buffer:350}}});Ext.apply(this,{items:[filterField,{iconCls:'icon-expand-all',tooltip:'Expand All',handler:function(){self.fireEvent('expandAll');}},{iconCls:'icon-collapse-all',tooltip:'Collapse All',handler:function(){self.fireEvent('collapseAll');}}]});Rwiki.Tree.Toolbar.superclass.constructor.apply(this,arguments);this.addEvents('filterFieldChanged','expandAll','collapseAll');}});Ext.ns('Rwiki.Tree');Rwiki.Tree.Loader=Ext.extend(Ext.tree.TreeLoader,{constructor:function(){Ext.apply(this,{requestMethod:'GET',dataUrl:'/nodes',preloadChildren:true});Rwiki.Tree.Loader.superclass.constructor.apply(this,arguments);this.on('beforeload',function(loader,node){loader.baseParams={path:node.getPath('baseName')}});},createNode:function(attr){return new Rwiki.Tree.Node(attr);}});Ext.ns('Rwiki');Rwiki.NavigationPanel=Ext.extend(Ext.Panel,{constructor:function(){Ext.apply(this,{region:'west',layout:'border',header:true,title:'Navigation panel',split:true,collapsible:true,width:255,minSize:255,maxSize:500,margins:'3 0 3 3',cmargins:'3 3 3 3'});Rwiki.NavigationPanel.superclass.constructor.apply(this,arguments);}});Ext.ns('Rwiki');Rwiki.rootFolderName='Home';Rwiki.captureEvents=function(observable){Ext.util.Observable.capture(observable,function(eventName,data){if(!window.console)return;console.log(data);console.log(eventName);});};Rwiki.init=function(){Ext.History.init();var firstLoad=true;Rwiki.ajaxCallCompleted=true;Rwiki.treeLoaded=false;Rwiki.treePanel=new Rwiki.TreePanel();Rwiki.nodeManager=Rwiki.Data.NodeManager.getInstance();Rwiki.captureEvents(Rwiki.nodeManager);Rwiki.nodeManager.on('rwiki:beforePageLoad',function(){Rwiki.ajaxCallCompleted=false;Rwiki.statusBar.showBusy();});Rwiki.nodeManager.on('rwiki:pageLoaded',function(){Rwiki.ajaxCallCompleted=true;Rwiki.statusBar.clearStatus({useDefaults:true});});Rwiki.statusBar=new Ext.ux.StatusBar({statusAlign:'right',defaultText:'Ready',iconCls:'x-status-valid'});Rwiki.treePanel.getLoader().on('load',function(){Rwiki.treeLoaded=true;Rwiki.treePanel.openNodeFromLocationHash();});Rwiki.tabPanel=new Rwiki.TabPanel({bbar:Rwiki.statusBar});Rwiki.tabPanel.relayEvents(Rwiki.treePanel,['rwiki:pageSelected']);var editorWindow=new Rwiki.EditorWindow();Rwiki.tabPanel.on('rwiki:editPage',function(path){if(!editorWindow.isVisible()){editorWindow.setPagePath(path);editorWindow.show();}});Ext.History.on('change',function(){Rwiki.treePanel.openNodeFromLocationHash();});var navigationPanel=new Rwiki.NavigationPanel({items:[Rwiki.treePanel]});var app=new Ext.Viewport({layout:'border',plain:true,renderTo:Ext.getBody(),items:[navigationPanel,Rwiki.tabPanel]});app.show();var map=new Ext.KeyMap(document,[{key:"e",alt:true,stopEvent:true,fn:function(){Rwiki.tabPanel.onEditPage();}},{key:"t",ctrl:true,stopEvent:true,fn:function(){Rwiki.tabPanel.onFuzzyFinder();}},{key:"w",ctrl:true,stopEvent:true,fn:function(){var tab=Rwiki.tabPanel.getActiveTab();Rwiki.tabPanel.remove(tab);}}]);};
